1)ProductController.cs:

// using Microsoft.AspNetCore.Mvc;
// using ProductCatalogAPI.Models;
// using ProductCatalogAPI.Services;


// namespace ProductCatalogAPI.Controllers
// {
//     [Route("api/products")]
//     [ApiController]
//     public class ProductsController : ControllerBase
//     {
//         private readonly IProductService _productService;

//         public ProductsController(IProductService productService)
//         {
//             _productService = productService;
//         }

//         // GET: api/products
//         [HttpGet]
//         public async Task<ActionResult<IEnumerable<Product>>> GetAllProducts()
//         {
//             try
//             {
//                 var products = await _productService.GetAllProductsAsync();
//                 return Ok(products);
//             }
//             catch (Exception ex)
//             {
//                 return StatusCode(500, $"Internal server error: {ex.Message}");
//             }
//         }

//         // POST: api/products
//         [HttpPost]
//         //[Authorize(Roles = "Admin")]
//         public async Task<ActionResult> CreateProduct([FromBody] ProductCreateDTO productCreateDTO)
//         {
//             if (productCreateDTO == null)
//             {
//                 return BadRequest("Product data is invalid.");
//             }

//             try
//             {
//                 // Call service layer to handle validation and adding product
//                 var result = await _productService.AddProductAsync(productCreateDTO);

//                 if (result.Success)
//                 {
//                     return CreatedAtAction(nameof(GetAllProducts), new { id = result.Product.ProductID }, result.Product);
//                 }

//                 return BadRequest(result.Message); // Return validation or error message
//             }
//             catch (Exception ex)
//             {
//                 return StatusCode(500, $"Internal server error: {ex.Message}");
//             }
//         }



//     }
// }

using Microsoft.AspNetCore.Mvc;
using ProductCatalogAPI.Models;
using ProductCatalogAPI.Services;

namespace ProductCatalogAPI.Controllers
{
    [Route("api/products")]
    [ApiController]
    public class ProductsController : ControllerBase
    {
        private readonly IProductService _productService;

        public ProductsController(IProductService productService)
        {
            _productService = productService;
        }

        // GET: api/products
        [HttpGet]
        public async Task<ActionResult<IEnumerable<Product>>> GetAllProducts()
        {
            try
            {
                var products = await _productService.GetAllProductsAsync();
                return Ok(products);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Internal server error: {ex.Message}");
            }
        }

        // POST: api/products
        [HttpPost]
        //[Authorize(Roles = "Admin")]
        public async Task<ActionResult> CreateProduct([FromBody] ProductCreateDTO productCreateDTO)
        {
            if (productCreateDTO == null)
            {
                return BadRequest("Product data is invalid.");
            }

            try
            {
                // Call service layer to handle validation and adding product
                var result = await _productService.AddProductAsync(productCreateDTO);

                if (result.Success)
                {
                    return CreatedAtAction(nameof(GetAllProducts), new { id = result.Product.ProductID }, result.Product);
                }

                return BadRequest(result.Message); // Return validation or error message
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Internal server error: {ex.Message}");
            }
        }

        [HttpPost("check-sku")]
        public async Task<IActionResult> CheckSku([FromBody] string sku)
        {
            if (string.IsNullOrEmpty(sku))
            {
                return BadRequest("SKU cannot be empty.");
            }

            bool isUnique = await _productService.IsSkuUniqueAsync(sku);

            if (isUnique)
            {
                return Ok();  // SKU is unique
            }

            return Conflict("SKU already exists.");  // Return a conflict status if SKU exists
        }
    }
}





2)CategoryController.cs:
using Microsoft.AspNetCore.Mvc;
using ProductCatalogAPI.Models;
using ProductCatalogAPI.Services;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace ProductCatalogAPI.Controllers
{
    [Route("api/categories")]
    [ApiController]
    public class CategoriesController : ControllerBase
    {
        private readonly ICategoryService _categoryService;

        public CategoriesController(ICategoryService categoryService)
        {
            _categoryService = categoryService;
        }

        // GET: api/categories
        [HttpGet]
        public async Task<ActionResult<IEnumerable<Category>>> GetAllCategories()
        {
            try
            {
                var categories = await _categoryService.GetAllCategoriesAsync();
                return Ok(categories); // 200 OK with the list of categories
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Internal server error: {ex.Message}");
            }
        }

        // POST: api/categories
        [HttpPost]
        public async Task<ActionResult<Category>> CreateCategory([FromBody] Category category)
        {
            try
            {
                if (category == null)
                {
                    return BadRequest("Category data is invalid.");
                }

                var newCategory = await _categoryService.AddCategoryAsync(category);

                // Return a Created response with the URI of the newly created category
                return CreatedAtAction(nameof(GetAllCategories), new { id = newCategory.CategoryID }, newCategory);
            }
            catch (ArgumentException ex)
            {
                return BadRequest(ex.Message); // Return 400 if there's a validation error
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Internal server error: {ex.Message}");
            }
        }
    }
}



3)AppDbContext.cs:
          
using Microsoft.EntityFrameworkCore;
using ProductCatalogAPI.Models;

namespace ProductCatalogAPI.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options)
            : base(options)
        {
        }

        public DbSet<Product> Products { get; set; }
        public DbSet<Category> Categories { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            //SKU is unique
            modelBuilder.Entity<Product>()
                .HasIndex(p => p.SKU)
                .IsUnique();

            // one to many relationship between Product and Category
            modelBuilder.Entity<Product>()
                .HasOne(p => p.Category)
                .WithMany() 
                .HasForeignKey(p => p.CategoryID)
                .OnDelete(DeleteBehavior.Restrict);
        }
    }
}

4)Category.cs:
using System;
using System.ComponentModel.DataAnnotations;

namespace ProductCatalogAPI.Models
{
    public class Category
    {
        [Key]
        public int CategoryID { get; set; } // Primary Key 

        [Required]
        public string Name { get; set; }

        //Navigation property for related products
        public ICollection<Product> Products { get; set; }
    }
}





5)Product.cs:
using System;
using System.ComponentModel.DataAnnotations;

namespace ProductCatalogAPI.Models
{
    public class Product
    {
        [Key]
        public int ProductID { get; set; }

        [Required]
        [MaxLength(100, ErrorMessage = "Product name should not exceed 100 characters.")]
        public string Name { get; set; }

        [Required]
        public string Description { get; set; }

        [Required]
        [RegularExpression(@"^[A-Za-z0-9_-]+$", ErrorMessage = "SKU can only contain alphanumeric characters (A-Z, a-z, 0-9), hyphen(-), and underscore(_)")]
        public string SKU { get; set; }

        [Required]
        public int CategoryID { get; set; } // Foreign key
        public Category? Category { get; set; } 

        [Range(0, int.MaxValue, ErrorMessage = "Stock quantity cannot be less than zero.")]
        public int StockQuantity { get; set; }

        [Required]
        [Range(0.01, double.MaxValue, ErrorMessage = "Price must be greater than zero.")]
        public decimal Price { get; set; }

        [Required]
        public string Currency { get; set; }

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
    }
}

6)ProductDTO.cs:
namespace ProductCatalogAPI.Models
{
    public class ProductCreateDTO
    {
        public string Name { get; set; }
        public string Description { get; set; }
        public string SKU { get; set; }
        public int CategoryID { get; set; }
        public int StockQuantity { get; set; }
        public decimal Price { get; set; }
        public string Currency { get; set; }
    }
}


7)launchsettings.json:
{
  "$schema": "https://json.schemastore.org/launchsettings.json",
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5014",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "https://localhost:7033;http://localhost:5014",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}


8)CategoryRepository.cs:
using Microsoft.EntityFrameworkCore;
using ProductCatalogAPI.Data;
using ProductCatalogAPI.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace ProductCatalogAPI.Repositories
{
    public class CategoryRepository : ICategoryRepository
    {
        private readonly AppDbContext _context;

        public CategoryRepository(AppDbContext context)
        {
            _context = context;
        }

        // Get a category by ID
        public async Task<Category> GetByIdAsync(int categoryId)
        {
            return await _context.Categories
                .FirstOrDefaultAsync(c => c.CategoryID == categoryId);
        }

        // Get all categories
        public async Task<IEnumerable<Category>> GetAllAsync()
        {
            return await _context.Categories.ToListAsync();
        }

        // Add a new category
        public async Task<Category> AddAsync(Category category)
        {
            await _context.Categories.AddAsync(category);
            await _context.SaveChangesAsync();
            return category;
        }

        // Save changes to the database
        public async Task<bool> SaveAsync()
        {
            var result = await _context.SaveChangesAsync();
            return result > 0;
        }
    }
}

9)ICategoryRepository.cs:
  using ProductCatalogAPI.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace ProductCatalogAPI.Repositories
{
    public interface ICategoryRepository
    {
        Task<Category> GetByIdAsync(int categoryId);
        Task<IEnumerable<Category>> GetAllAsync();
        Task<Category> AddAsync(Category category); // Add new category
        Task<bool> SaveAsync();
    }
}

10)IProductRepository.cs:
  using ProductCatalogAPI.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace ProductCatalogAPI.Repositories
{
    public interface IProductRepository
    {
        Task<Product> AddAsync(Product product);
        Task<IEnumerable<Product>> GetAllAsync();
        Task<bool> IsSkuUniqueAsync(string sku); // Check if SKU is unique
        Task<bool> SaveAsync(); // Save changes to the database
    }
}

  11)ProductRepository.cs:
  using Microsoft.EntityFrameworkCore;
using ProductCatalogAPI.Data;
using ProductCatalogAPI.Models;

namespace ProductCatalogAPI.Repositories
{
    public class ProductRepository : IProductRepository
    {
        private readonly AppDbContext _context;

        public ProductRepository(AppDbContext context)
        {
            _context = context;
        }

        // Add a new product to the database
        public async Task<Product> AddAsync(Product product)
        {
            await _context.Products.AddAsync(product);
            await _context.SaveChangesAsync();
            return product; // Return the added product (can be useful for response)
        }

        // Get all products
        public async Task<IEnumerable<Product>> GetAllAsync()
        {
            return await _context.Products.ToListAsync();
        }

       // Implement the SKU uniqueness check
        public async Task<bool> IsSkuUniqueAsync(string sku)
        {
            // Check if a product with the same SKU already exists
            return !await _context.Products.AnyAsync(p => p.SKU == sku);
        }

        // Save changes to the database
        public async Task<bool> SaveAsync()
        {
            var saved = await _context.SaveChangesAsync();
            return saved > 0; // Return true if any rows were affected
        }
    }
}

  12)CategoryServices.cs:
  using ProductCatalogAPI.Models;
using ProductCatalogAPI.Repositories;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace ProductCatalogAPI.Services
{
    public class CategoryService : ICategoryService
    {
        private readonly ICategoryRepository _categoryRepository;

        public CategoryService(ICategoryRepository categoryRepository)
        {
            _categoryRepository = categoryRepository;
        }

        // Get a category by ID
        public async Task<Category> GetCategoryByIdAsync(int categoryId)
        {
            return await _categoryRepository.GetByIdAsync(categoryId);
        }

        // Get all categories
        public async Task<IEnumerable<Category>> GetAllCategoriesAsync()
        {
            return await _categoryRepository.GetAllAsync();
        }

        // Add a new category
        public async Task<Category> AddCategoryAsync(Category category)
        {
            // Business logic validation (you can extend this as needed)
            if (string.IsNullOrEmpty(category.Name))
            {
                throw new ArgumentException("Category name cannot be empty.");
            }

            // Add category via repository
            return await _categoryRepository.AddAsync(category);
        }
    }
}
13)ICategoryService.cs:

  using ProductCatalogAPI.Models;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace ProductCatalogAPI.Services
{
    public interface ICategoryService
    {
        Task<Category> GetCategoryByIdAsync(int categoryId); // Get a category by ID
        Task<IEnumerable<Category>> GetAllCategoriesAsync(); // Get all categories
        Task<Category> AddCategoryAsync(Category category); // Add a new category
    }
}
14)IProductService.cs:

  using ProductCatalogAPI.Models;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace ProductCatalogAPI.Services
{
    public interface IProductService
    {
        // Method to add a new product using ProductCreateDTO
        Task<ServiceResult> AddProductAsync(ProductCreateDTO productCreateDTO);

        // Method to get all products
        Task<IEnumerable<Product>> GetAllProductsAsync();

        Task<bool> IsSkuUniqueAsync(string sku);
    }
}

  15)ProductService.cs:

  using ProductCatalogAPI.Models;
using ProductCatalogAPI.Repositories;

namespace ProductCatalogAPI.Services
{
    public class ProductService : IProductService
    {
        private readonly IProductRepository _productRepository;

        public ProductService(IProductRepository productRepository)
        {
            _productRepository = productRepository;
        }

        // Check if SKU is unique
        public async Task<bool> IsSkuUniqueAsync(string sku)
        {
            return await _productRepository.IsSkuUniqueAsync(sku);
        }

        // Add a new product with validation and error handling
        public async Task<ServiceResult> AddProductAsync(ProductCreateDTO productCreateDTO)
        {
            try
            {

                // Validate other properties of the DTO
                if (string.IsNullOrEmpty(productCreateDTO.Name))
                {
                    return new ServiceResult { Success = false, Message = "Product name is required." };
                }

                if (productCreateDTO.Name.Length > 100)
                {
                    return new ServiceResult { Success = false, Message = "Product name cannot exceed 100 characters." };
                }

                if (string.IsNullOrEmpty(productCreateDTO.SKU))
                {
                    return new ServiceResult { Success = false, Message = "SKU is required." };
                }

                if (productCreateDTO.Price <= 0)
                {
                    return new ServiceResult { Success = false, Message = "Price must be greater than zero." };
                }

                // Map DTO to Product model
                var product = new Product
                {
                    Name = productCreateDTO.Name,
                    Description = productCreateDTO.Description,
                    SKU = productCreateDTO.SKU,
                    CategoryID = productCreateDTO.CategoryID,
                    StockQuantity = productCreateDTO.StockQuantity,
                    Price = productCreateDTO.Price,
                    Currency = "INR", // You might need to use productCreateDTO.Currency depending on your requirements
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                // Save product to the database
                var addedProduct = await _productRepository.AddAsync(product);

                return new ServiceResult
                {
                    Success = true,
                    Message = "Product added successfully.",
                    Product = addedProduct // Return the created product
                };
            }
            catch (Exception ex)
            {
                return new ServiceResult
                {
                    Success = false,
                    Message = ex.Message // Return the exception message if any error occurs
                };
            }
        }

        // Get all products
        public async Task<IEnumerable<Product>> GetAllProductsAsync()
        {
            return await _productRepository.GetAllAsync();
        }
    }
}
16)Utility/ServiceResult.cs:
  namespace ProductCatalogAPI.Models
{
    public class ServiceResult
    {
        public bool Success { get; set; }
        public string Message { get; set; }
        public Product Product { get; set; } 
    }
}
17)Program.cs:

  using Microsoft.EntityFrameworkCore;
using ProductCatalogAPI.Models;
using ProductCatalogAPI.Data;
using ProductCatalogAPI.Repositories;
using ProductCatalogAPI.Services;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

// Register the DbContext with SQL Server connection
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// Register the repositories and services
builder.Services.AddScoped<IProductRepository, ProductRepository>();
builder.Services.AddScoped<IProductService, ProductService>();
builder.Services.AddScoped<ICategoryRepository, CategoryRepository>();
builder.Services.AddScoped<ICategoryService, CategoryService>();

// Add controllers to the service container (move this up)
builder.Services.AddControllers();

// Register Swagger/OpenAPI services
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new Microsoft.OpenApi.Models.OpenApiInfo
    {
        Title = "Product Management API",
        Version = "v1",
        Description = "API for managing products and categories in a catalog",
    });
});

builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowCors",
        policy =>
        {
            policy.WithOrigins("http://localhost:4200")
                  .AllowAnyMethod()
                  .AllowAnyHeader()
                  .AllowCredentials();
        });
});

var app = builder.Build();

// Use CORS middleware
app.UseCors("AllowCors");

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "Product Management API V1");
        c.RoutePrefix = string.Empty;  // This will serve the Swagger UI at the root of the application
    });
}

app.UseRouting();

// Add endpoint routing for controllers
app.MapControllers();

// Enable HTTPS redirection
app.UseHttpsRedirection();

app.Run();  // Finally, run the app after configuring everything



